<?xml version="1.0" encoding="utf-8"?>
<package name="imageclassifier" displayName="Image Classifier" description="Image classifier using semantic image segmentation" version="1.0.4" url="https://apexrms.github.io/imageclassifier/">

    <!--Model Inputs-->
            
    <dataSheet name="InputRasters" displayName="Input rasters">
        <column name="Timesteps" dataType="Integer" displayName="Timestep"/>
        <column name="TrainingRasterFile" dataType="String" displayName="Training raster" isExternalFile="True"/>
        <column name="GroundTruthRasterFile" dataType="String" displayName="Ground truth raster" isExternalFile="True"/>
        <column name="RasterFileToClassify" dataType="String" displayName="Raster to Classfiy" isExternalFile="True"/>
    </dataSheet>

    <dataSheet name="ClassifierOptions" displayName="Classifier options" isSingleRow="True">
        <column name="nObs" dataType="Integer" displayName="Sample size"/>
        <column name="applyContextualization" dataType="Boolean" displayName="Apply contextualization"/>
        <column name="modelType" displayName="Model type" dataType="Integer" validationType="List" formula1="0:Random Forest|1:MaxEnt" isOptional="True"/>
    </dataSheet>

    <dataSheet name="PostProcessingOptions" displayName="Post-processing options" isSingleRow="True">
        <column name="applyFiltering" dataType="Boolean" displayName="Apply filtering"/>
        <column name="filterResolution" dataType="Double" displayName="Filter resolution (optional)"/>
        <column name="filterPercent" dataType="Double" displayName="Filter threshold (optional)"/>
    </dataSheet>

    <!--Model Outputs-->
    <dataSheet name="RasterOutput" displayName="Training Rasters" hasTimestep="True">
        <column name="PredictedUnfiltered" dataType="String" displayName="Predicted" isExternalFile="True" isRaster="True" bandColumn="Band"/>
        <column name="PredictedFiltered" dataType="String" displayName="Predicted filtered" isExternalFile="True" isRaster="True" bandColumn="Band"/>
        <column name="GroundTruth" dataType="String" displayName="Ground truth" isExternalFile="True" isRaster="True"/>
        <column name="Probability" dataType="String" displayName="Probability" isExternalFile="True" isRaster="True"/>
        <column name="Band" displayName="Band" dataType="Integer" allowDbNull="True" isOptional="True"/>
    </dataSheet>

    <dataSheet name="ClassifiedRasterOutput" displayName="Classified Rasters" hasTimestep="True">
        <column name="ClassifiedUnfiltered" dataType="String" displayName="Classified" isExternalFile="True" isRaster="True" bandColumn="Band"/>
        <column name="ClassifiedFiltered" dataType="String" displayName="Classified filtered" isExternalFile="True" isRaster="True" bandColumn="Band"/>
        <column name="ClassifiedProbability" dataType="String" displayName="Probability" isExternalFile="True" isRaster="True"/>
        <column name="Band" displayName="Band" dataType="Integer" allowDbNull="True" isOptional="True"/>
    </dataSheet>

    <dataSheet name="ConfusionMatrix" displayName="Confusion matrix">
        <column name="Prediction" dataType="Integer" displayName="Prediction"/>
        <column name="Reference" dataType="Integer" displayName="Reference"/>
        <column name="Frequency" dataType="Double" displayName="Frequency"/>
    </dataSheet>

    <dataSheet name="ModelStatistics" displayName="Statistics">
        <column name="Statistic" dataType="String" displayName="Statistic"/>
        <column name="Value" dataType="Double" displayName="Value"/>
    </dataSheet>

    <dataSheet name="VariableImportanceOutput" displayName="Variable Importance">
	    <column name="VariableImportance" dataType="String" isExternalFile="True" isImage="True"/>
    </dataSheet>

    <dataSheet name="ConfusionMatrixPlotOutput" displayName="Confusion Matrix">
	    <column name="ConfusionMatrixPlot" dataType="String" isExternalFile="True" isImage="True"/>
    </dataSheet>

    <dataSheet name="RgbOutput" displayName="RGB Images" hasTimestep="True">
	    <column name="RGBImage" dataType="String" isExternalFile="True" isImage="True"/>
    </dataSheet>

    <dataSheet name="ClassifiedRgbOutput" displayName="RGB Images" hasTimestep="True">
	    <column name="RGBImage" dataType="String" isExternalFile="True" isImage="True"/>
    </dataSheet>

    <dataSheet name="ModelObject" displayName="Model">
	    <column name="Model" dataType="String" isExternalFile="True"/>
        <column name="OptimalThreshold" dataType="Double"/>
    </dataSheet>

    <!--Transformer 1: training classifier-->
    <transformer name="TrainClassifier" displayName="1-Train Classifier" programName="Rscript" programArguments="1-train-classifier.R" condaEnv="watchtower-conda.yml" condaEnvVersion="12">
        <dataSheet name="InputRasters" type="Input"/>
        <dataSheet name="ClassifierOptions" type="Input"/>
        <dataSheet name="RasterOutput" type="Output"/>
        <dataSheet name="ClassifiedRasterOutput" type="Output"/>
        <dataSheet name="ConfusionMatrix" type="Output"/>
        <dataSheet name="ModelStatistics" type="Output"/>
        <dataSheet name="VariableImportanceOutput" type="Output"/>
        <dataSheet name="ConfusionMatrixPlotOutput" type="Output"/>
        <dataSheet name="RgbOutput" type="Output"/>
        <dataSheet name="ModelObject" type="Output"/>
    </transformer>

    <!--Transformer 2: forecasting-->
    <transformer name="Forecast" displayName="2-Forecast" programName="Rscript" programArguments="2-forecast.R" condaEnv="watchtower-conda.yml" condaEnvVersion="12">
        <dataSheet name="InputRasters" type="Input"/>
        <dataSheet name="ClassifierOptions" type="Input"/>
        <dataSheet name="PostProcessingOptions" type="Input"/>
        <dataSheet name="ModelObject" type="Input"/>
        <dataSheet name="ClassifiedRasterOutput" type="Output"/>
        <dataSheet name="ClassifiedRgbOutput" type="Output"/>
    </transformer>

    <!--Export transformers-->
    <transformer name="ConfusionMatrixExport" dataSheet="ConfusionMatrix" isExport="True"/>
    <transformer name="ModelStatisticsExport" dataSheet="ModelStatistics" isExport="True"/>
    <transformer name="PredictedUnfilteredExport" dataSheet="RasterOutput" column="PredictedUnfiltered" isRasterExport="True"/>
    <transformer name="PredictedFilteredExport" dataSheet="RasterOutput" column="PredictedFiltered" isRasterExport="True"/>
    <transformer name="GroundTruthExport" dataSheet="RasterOutput" column="GroundTruth" isRasterExport="True"/>
    <transformer name="VariableImportanceOutputExport" dataSheet="VariableImportanceOutput" column="VariableImportance" isExport="True"/>

    <!--Scenario Layout-->
    <layout type="Scenario">

        <group name="AllInputs" displayName="Input">
            <item name="ClassifierOptions"/>
            <item name="PostProcessingOptions"/>
            <item name="InputRasters"/>
        </group>

        <group name="AllOutputs" displayName="Output">
            <item name="ConfusionMatrix"/>
            <item name="ModelStatistics"/>
        </group>

    </layout>

    <!--Map Layout-->
	<layout type="Map">
        <group name="PredictionMaps" displayName="Training Predictions">
		    <item name="PredictedUnfilteredMap" displayName="Unfiltered" dataSheet="RasterOutput" column="PredictedUnfiltered"/>
            <item name="PredictedFilteredMap" displayName="Filtered" dataSheet="RasterOutput" column="PredictedFiltered"/>
            <item name="ProbabilityMap" displayName="Probability" dataSheet="RasterOutput" column="Probability"/>
            <item name="GroundTruthMap" displayName="Ground Truth" dataSheet="RasterOutput" column="GroundTruth"/>
        </group>
        <group name="ClassifiedPredictionMaps" displayName="Classified Predictions">
		    <item name="ClassifiedUnfilteredMap" displayName="Unfiltered" dataSheet="ClassifiedRasterOutput" column="ClassifiedUnfiltered"/>
            <item name="ClassifiedFilteredMap" displayName="Filtered" dataSheet="ClassifiedRasterOutput" column="ClassifiedFiltered"/>
            <item name="ClassifiedProbabilityMap" displayName="Probability" dataSheet="ClassifiedRasterOutput" column="ClassifiedProbability"/>
        </group>
    </layout>

    <!--Image Layout-->
    <layout type="Image">	
        <item name="VariableImportancePlot" displayName="Variable Importance Plot" dataSheet="VariableImportanceOutput" column="VariableImportance"/>
        <item name="ConfusionMatrixPlotOutputImage" displayName="Confusion Matrix" dataSheet="ConfusionMatrixPlotOutput" column="ConfusionMatrixPlot"/>
        <group name="RGBImagePlots" displayName="RGB Images">
            <item name="TrainingRGBImagePlots" displayName="Training" dataSheet="RgbOutput" column="RGBImage"/>
            <item name="ClassifiedRGBImagePlots" displayName="Classified" dataSheet="ClassifiedRgbOutput" column="RGBImage"/>
        </group>
    </layout>

    <!--Export Layout-->
    <layout type="Export">
        <item name="ConfusionMatrixExport" displayName="Confusion Matrix"/>
        <item name="ModelStatisticsExport" displayName="Model Statistics"/>

        <group name="MapExport" displayName="Map Outputs">
            <item name="PredictedUnfilteredExport" displayName="Unfiltered Prediction"/>
            <item name="PredictedFilteredExport" displayName="Filtered Prediction"/>
            <item name="GroundTruthExport" displayName="Ground Truth"/>
        </group>
        <group name="ImageExport" displayName="Image Outputs">
            <item name="VariableImportanceOutputExport" displayName="Variable Importance Plot"/>
        </group>
    </layout>

</package>